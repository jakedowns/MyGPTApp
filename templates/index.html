<!DOCTYPE html>
<html>
<head>
    <title>Chatbot</title>
</head>
<body>
    <h1>Chatbot</h1>
    <div id="chat-history">
    </div>
    <div>
        <form onsubmit="submitForm(event)" onkeydown="maybeSubmit">
            <textarea id="prompt" name="prompt" rows="4" cols="30" autocomplete="false"></textarea>
            <input type="submit" value="Submit">
        </form>
    </div>
    <script>
        window.maybeSubmit = function(e){
            // if the user pressed enter with NO modifier, then submit the form
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                submitForm(e);
            } 
        }

        let messageHistory = [];
        function bootup(){
            console.log('booting up');
            // GET our bootup endpoint and retrieve all previous messages in the conversation
            const xhr = new XMLHttpRequest();   
            xhr.open('GET', '/bootup'); 
            xhr.onload = () => {
                const decoded = JSON.parse(xhr.response);
                console.log({response:xhr.response, decoded});
                messageHistory = decoded;

                renderMessages();

                // scroll to bottom of page
                window.scrollTo(0,document.body.scrollHeight);
            }; 
            xhr.send(); 
        }
        bootup();

        function renderMessages(){
            // clear the #chat-history
            // print current message list
            const chatHistory = document.getElementById('chat-history');    
            chatHistory.innerHTML = ''; 
            messageHistory.forEach(message => {
                const newMessage = document.createElement('div');
                newMessage.classList.add('message');

                const newMessageInnerParticipant = document.createElement('div');
                newMessageInnerParticipant.classList.add('message-participant');    
                newMessageInnerParticipant.innerText = message.role;
                newMessage.appendChild(newMessageInnerParticipant); 
                
                const newMessageInnerMessage = document.createElement('div');
                newMessageInnerMessage.classList.add('message-message');        
                newMessageInnerMessage.innerText = message.content;
                newMessage.appendChild(newMessageInnerMessage); 

                // convert timestamp to human readable time
                const newMessageInnerTimestamp = document.createElement('div'); 
                newMessageInnerTimestamp.classList.add('message-timestamp');    
                newMessageInnerTimestamp.innerText = new Date(message.created_at).toLocaleTimeString();  
                newMessage.appendChild(newMessageInnerTimestamp);

                chatHistory.appendChild(newMessage);
            });
        }

        function submitForm(event) {
            event.preventDefault();
            const prompt = document.getElementById('prompt').value;

            messageHistory.push({role:'user',content:prompt});  
            renderMessages();

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/gpt');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = () => {
                const decoded = JSON.parse(xhr.response);
                console.log({response:xhr.response, decoded});
                messageHistory.push(decoded.choices[0].message);  
                renderMessages();
            };
            xhr.send(JSON.stringify({prompt}));
            // clear prompt area
            document.getElementById('prompt').value = '';
        }
    </script>
    <style>
        form {
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            background-color: #333;
        }
        form textarea {
            width: 100%;
        }
        #chat-history {
          display: flex;
          flex-direction: column;
          gap: 10px;
          padding: 10px;
          background-color: #f7f7f7;
          margin-bottom: 100px;
        }

        .message {
          display: flex;
          flex-direction: row;
          gap: 10px;
          padding: 5px;
          border-radius: 5px;
          background-color: #ffffff;
        }

        .message-participant {
          font-weight: bold;
        }

        .message-timestamp {
          font-size: 0.8em;
          color: #666666;
        }

        .message-participant[data-participant="user"] {
          color: #007bff;
        }

        .message-participant[data-participant="assistant"] {
          color: #28a745;
        }
    </style>
</body>
</html>
